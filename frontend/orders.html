<!-- üìÅ public/orders.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
  <!-- üß≠ Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="products.html">üõçÔ∏è Shop</a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="products.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="cart.html">Cart</a></li>
          <li class="nav-item"><a class="nav-link active" href="orders.html">Orders</a></li>
        </ul>
        <div class="d-flex gap-2">
          <input class="form-control" type="search" id="searchInput" placeholder="Search products..." />
          <button class="btn btn-outline-light" onclick="searchProducts()">Search</button>
          <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- üìã Orders -->
  <div class="container mt-4">
    <h2>üßæ Your Orders</h2>
    <div id="ordersContainer" class="mt-4"></div>
  </div>

  <script>
    const jwtToken = localStorage.getItem("jwtToken");

    function logout() {
      localStorage.removeItem("jwtToken");
      window.location.href = "login.html";
    }

    function searchProducts() {
      const query = document.getElementById("searchInput").value.trim();
      if (query) {
        window.location.href = `products.html?search=${encodeURIComponent(query)}`;
      }
    }

    async function cancelOrder(id) {
      const confirmed = confirm("Are you sure you want to cancel this order?");
      if (!confirmed) return;

      await fetch(`http://localhost:3000/orders/${id}/cancel`, {
        method: "PATCH",
        headers: { Authorization: `Bearer ${jwtToken}` }
      });

      fetchOrders();
    }

    async function fetchOrders() {
      const res = await fetch("http://localhost:3000/orders", {
        headers: { Authorization: `Bearer ${jwtToken}` }
      });

      const orders = await res.json();
      const container = document.getElementById("ordersContainer");
      container.innerHTML = "";

      if (!orders.length) {
        container.innerHTML = `<p class="text-muted">You haven't placed any orders yet.</p>`;
        return;
      }

      orders.forEach(order => {
        let total = 0;
        const itemsHtml = order.items.map(item => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          return `
            <li class="list-group-item">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>${item.name}</strong> √ó ${item.quantity}<br/>
                  <small class="text-muted">${item.category || ''}</small><br/>
                  <small>${item.description || ''}</small>
                </div>
                <span>‚Çπ${itemTotal.toFixed(2)}</span>
              </div>
            </li>
          `;
        }).join("");

        const formattedDate = new Date(order.date_time).toLocaleDateString();

        const cancelBtn = !order.cancel_order
          ? `<button class="btn btn-sm btn-danger mt-2" onclick="cancelOrder(${order.order_id})">Cancel Order</button>`
          : `<span class="badge bg-secondary mt-2">Cancelled</span>`;

        const orderCard = `
          <div class="card mb-4 shadow-sm">
            <div class="card-header fw-bold">
              üßæ Order #${order.order_id} ‚Äî ${formattedDate}
            </div>
            <ul class="list-group list-group-flush">${itemsHtml}</ul>
            <div class="card-footer d-flex justify-content-between align-items-center">
              <div class="fw-bold">Total: ‚Çπ${total.toFixed(2)}</div>
              ${cancelBtn}
            </div>
          </div>
        `;
        container.innerHTML += orderCard;
      });
    }

    fetchOrders();
  </script>
</body>
</html>